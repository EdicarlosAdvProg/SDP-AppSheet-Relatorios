<script>
  // ================================================================
  // ESTADO GLOBAL DO PAINEL LATERAL
  // Centraliza todos os dados em memória para evitar chamadas
  // desnecessárias ao servidor.
  // ================================================================
  var PL_estado = {
    sessaoAtualId:       null,
    pautasCarregadas:    {},   // Cache por sessaoId
    membros:             [],
    procuradores:        [],
    cacheMembros:        [],   // Lista completa para autocomplete
    cacheProcuradores:   []    // Lista completa para autocomplete
  };

  // ================================================================
  // PONTO DE ENTRADA ÚNICO
  // Chamado pelo DOMContentLoaded no layout, utilizando os dados
  // pré-injetados pelo servidor (DADOS_INICIAIS) para evitar
  // round-trip de rede desnecessário na abertura.
  // ================================================================
  function PL_JS_inicializarComDadosIniciais() {
    var inicial = window.DADOS_INICIAIS;
    if (!inicial) {
      PL_JS_mostrarErro('Falha ao receber dados iniciais do servidor.');
      return;
    }

    // 1. Popula caches de autocomplete
    PL_estado.cacheMembros      = inicial.cadastros.membros      || [];
    PL_estado.cacheProcuradores = inicial.cadastros.procuradores || [];

    // 2. Monta o dropdown de sessões
    PL_JS_onSessoesCarregadas(inicial.sessoes);

    // 3. Renderiza a pauta da sessão mais recente (já veio pronta)
    if (inicial.pautaAtiva && inicial.config.sessaoAtivaId) {
      PL_estado.pautasCarregadas[inicial.config.sessaoAtivaId] = inicial.pautaAtiva;
      PL_JS_onPautaCarregada(inicial.pautaAtiva);
    } else {
      PL_JS_mostrarLoading(false);
    }

    // 4. Configura autocompletes do Materialize APÓS renderização
    PL_JS_configurarAutocompletes();
  }

  // Fallback: Re-inicializar buscando sessões do servidor
  function PL_JS_inicializar() {
    PL_JS_mostrarLoading(true);
    google.script.run
      .withSuccessHandler(PL_JS_onSessoesCarregadas)
      .withFailureHandler(PL_JS_onErro)
      .PainelLateral_listarSessoes();
  }

  // ================================================================
  // DROPDOWN DE SESSÕES
  // ================================================================

  /** Popula o dropdown com a lista de sessões e seleciona a primeira */
  function PL_JS_onSessoesCarregadas(sessoes) {
    if (!sessoes || sessoes.length === 0) {
      PL_JS_mostrarErro('Nenhuma sessão encontrada na planilha.');
      return;
    }

    var listContainer = document.getElementById('listaSessoesDropdown');
    listContainer.innerHTML = '';

    sessoes.forEach(function (s) {
      var card = document.createElement('div');
      card.className = 'dropdown-item-card';
      card.setAttribute('data-id', s.id);
      card.onclick = function () { PL_JS_selecionarSessao(s.id); };
      card.innerHTML =
        '<span class="item-data">' + PL_JS_esc(s.data) + '</span>' +
        '<span class="item-orgao">' + PL_JS_esc(s.orgao) + '</span>';
      listContainer.appendChild(card);
    });

    // Seleciona a sessão mais recente por padrão
    if (sessoes.length > 0) {
      PL_JS_selecionarSessao(sessoes[0].id);
    }
  }

  function PL_JS_toggleDropdown() {
    document.getElementById('listaSessoesDropdown').classList.toggle('hidden');
  }

  function PL_JS_selecionarSessao(id) {
    document.getElementById('listaSessoesDropdown').classList.add('hidden');

    // Atualiza destaque visual
    document.querySelectorAll('.dropdown-item-card').forEach(function (el) {
      el.classList.toggle('active', el.getAttribute('data-id') == id);
    });

    PL_JS_carregarPauta(id);
  }

  /** Carrega a pauta: usa cache local se disponível, senão vai ao servidor */
  function PL_JS_carregarPauta(sessaoId) {
    if (PL_estado.pautasCarregadas[sessaoId]) {
      PL_JS_onPautaCarregada(PL_estado.pautasCarregadas[sessaoId]);
      return;
    }

    PL_JS_mostrarLoading(true);
    google.script.run
      .withSuccessHandler(function (dados) {
        PL_estado.pautasCarregadas[sessaoId] = dados;
        PL_JS_onPautaCarregada(dados);
      })
      .withFailureHandler(PL_JS_onErro)
      .PainelLateral_carregarPauta(sessaoId);
  }

  // Fecha dropdown ao clicar fora
  window.addEventListener('click', function (e) {
    var drop = document.getElementById('dropdownSessao');
    if (drop && !drop.contains(e.target)) {
      document.getElementById('listaSessoesDropdown').classList.add('hidden');
    }
  });

  // ================================================================
  // RENDERIZAÇÃO DA PAUTA
  // Recebe o objeto completo { sessao, fichas, membros,
  // procuradores, expediente } e atualiza toda a UI.
  // ================================================================
  function PL_JS_onPautaCarregada(dados) {
    PL_estado.sessaoAtualId  = dados.sessao.id;
    PL_estado.membros        = dados.membros       || [];
    PL_estado.procuradores   = dados.procuradores  || [];

    // Atualiza header
    document.getElementById('displayOrgao').textContent = dados.sessao.orgao || '—';
    document.getElementById('displayData').textContent  = dados.sessao.data  || '—';

    // Renderiza seções
    PL_JS_renderizarFichas(dados.fichas || []);
    PL_JS_renderizarChips('listaMembros',     'badgeMembros',     PL_estado.membros,      'PL_JS_removerMembro');
    PL_JS_renderizarChips('listaProcuradores','badgeProcuradores',PL_estado.procuradores, 'PL_JS_removerProcurador');

    document.getElementById('expedienteTexto').value = dados.expediente || '';
    // Dispara resize do Materialize textarea
    M.textareaAutoResize(document.getElementById('expedienteTexto'));

    PL_JS_mostrarLoading(false);
    document.getElementById('estadoErro').classList.add('hidden');
    document.getElementById('pautaContainer').classList.remove('hidden');
  }

  // ================================================================
  // FICHAS DE VOTAÇÃO
  // ================================================================
  function PL_JS_renderizarFichas(fichas) {
    var container = document.getElementById('fichasLista');
    document.getElementById('badgeFichas').textContent = fichas.length;

    if (fichas.length === 0) {
      container.innerHTML = '<div class="empty-state">Nenhuma ficha para esta sessão.</div>';
      return;
    }

    container.innerHTML = fichas.map(function (f) {
      return [
        '<div class="ficha-card">',
          '<div class="ficha-nivel1">',
            '<span class="ficha-ordem">' + PL_JS_esc(f.ordem) + 'º</span>',
            '<span class="ficha-processo">' + PL_JS_esc(f.processo) + '</span>',
          '</div>',
          '<div class="ficha-nivel2">',
            '<span class="ficha-label">REQ.</span>',
            '<span class="ficha-valor"><strong>' + PL_JS_esc(f.requerente) + '</strong></span>',
          '</div>',
          '<div class="ficha-nivel3">',
            '<span class="ficha-label">PROC.</span>',
            '<span class="ficha-valor">' + PL_JS_esc(f.procurador) + '</span>',
          '</div>',
          '<div class="ficha-nivel4">',
            '<span class="ficha-label">REL.</span>',
            '<span class="ficha-valor">' + PL_JS_esc(f.relator) + '</span>',
          '</div>',
        '</div>'
      ].join('');
    }).join('');
  }

  // ================================================================
  // CHIPS — RENDERIZAÇÃO GENÉRICA
  // Utilizada tanto para Membros quanto para Procuradores.
  // callbackRemover: nome da função como string (ex: 'PL_JS_removerMembro')
  // ================================================================
  function PL_JS_renderizarChips(containerId, badgeId, lista, callbackRemover) {
    var container = document.getElementById(containerId);
    document.getElementById(badgeId).textContent = lista.length;

    if (lista.length === 0) {
      container.innerHTML = '<div class="empty-state">Nenhum registro.</div>';
      return;
    }

    container.innerHTML = lista.map(function (nome, i) {
      return [
        '<div class="chip oab-chip">',
          PL_JS_esc(nome),
          '<i class="material-icons close" onclick="' + callbackRemover + '(' + i + ')">close</i>',
        '</div>'
      ].join('');
    }).join('');
  }

  // ================================================================
  // MEMBROS
  // ================================================================
  function PL_JS_adicionarMembro() {
    var input = document.getElementById('inputNovoMembro');
    var nome  = input.value.trim();
    if (!nome || PL_estado.membros.indexOf(nome) !== -1) { input.value = ''; return; }

    PL_estado.membros.push(nome);
    input.value = '';
    PL_JS_renderizarChips('listaMembros', 'badgeMembros', PL_estado.membros, 'PL_JS_removerMembro');
    PL_JS_persistirMembros();
  }

  function PL_JS_removerMembro(indice) {
    PL_estado.membros.splice(indice, 1);
    PL_JS_renderizarChips('listaMembros', 'badgeMembros', PL_estado.membros, 'PL_JS_removerMembro');
    PL_JS_persistirMembros();
  }

  function PL_JS_persistirMembros() {
    google.script.run
      .withSuccessHandler(function () { PL_JS_toast('Membros salvos.', 'ok'); })
      .withFailureHandler(function (e) { PL_JS_toast('Erro: ' + e.message, 'erro'); })
      .PainelLateral_salvarMembros(PL_estado.sessaoAtualId, PL_estado.membros);
  }

  // ================================================================
  // PROCURADORES
  // ================================================================
  function PL_JS_adicionarProcurador() {
    var input = document.getElementById('inputNovoProcurador');
    var nome  = input.value.trim();
    if (!nome || PL_estado.procuradores.indexOf(nome) !== -1) { input.value = ''; return; }

    PL_estado.procuradores.push(nome);
    input.value = '';
    PL_JS_renderizarChips('listaProcuradores', 'badgeProcuradores', PL_estado.procuradores, 'PL_JS_removerProcurador');
    PL_JS_persistirProcuradores();
  }

  function PL_JS_removerProcurador(indice) {
    PL_estado.procuradores.splice(indice, 1);
    PL_JS_renderizarChips('listaProcuradores', 'badgeProcuradores', PL_estado.procuradores, 'PL_JS_removerProcurador');
    PL_JS_persistirProcuradores();
  }

  function PL_JS_persistirProcuradores() {
    google.script.run
      .withSuccessHandler(function () { PL_JS_toast('Procuradores salvos.', 'ok'); })
      .withFailureHandler(function (e) { PL_JS_toast('Erro: ' + e.message, 'erro'); })
      .PainelLateral_salvarProcuradores(PL_estado.sessaoAtualId, PL_estado.procuradores);
  }

  // ================================================================
  // EXPEDIENTE
  // ================================================================
  function PL_JS_salvarExpediente() {
    var texto = document.getElementById('expedienteTexto').value;
    google.script.run
      .withSuccessHandler(function () { PL_JS_toast('Expediente salvo.', 'ok'); })
      .withFailureHandler(function (e) { PL_JS_toast('Erro: ' + e.message, 'erro'); })
      .PainelLateral_salvarExpediente(PL_estado.sessaoAtualId, texto);
  }

  // ================================================================
  // AUTOCOMPLETES DO MATERIALIZE
  // Deve ser chamado após a injeção dos dados iniciais.
  // O minLength: 0 garante que a lista apareça ao focar.
  // ================================================================
  function PL_JS_configurarAutocompletes() {
    // Converte arrays em formato de objeto { "nome": null } exigido pelo Materialize
    function toMaterializeData(arr) {
      var obj = {};
      (arr || []).forEach(function (n) { obj[n] = null; });
      return obj;
    }

    // Autocomplete de Membros
    var elMembro = document.getElementById('inputNovoMembro');
    if (elMembro) {
      var instMembro = M.Autocomplete.init(elMembro, {
        data:      toMaterializeData(PL_estado.cacheMembros),
        limit:     10,
        minLength: 0
      });
      elMembro.addEventListener('focus', function () { instMembro.open(); });
      elMembro.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); PL_JS_adicionarMembro(); }
      });
    }

    // Autocomplete de Procuradores
    var elProc = document.getElementById('inputNovoProcurador');
    if (elProc) {
      var instProc = M.Autocomplete.init(elProc, {
        data:      toMaterializeData(PL_estado.cacheProcuradores),
        limit:     10,
        minLength: 0
      });
      elProc.addEventListener('focus', function () { instProc.open(); });
      elProc.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); PL_JS_adicionarProcurador(); }
      });
    }
  }

  // ================================================================
  // FAB (BOTÃO FLUTUANTE)
  // ================================================================
  function PL_JS_toggleFab() {
    var options = document.getElementById('fabOptions');
    var btn     = document.getElementById('fabMain');
    options.classList.toggle('show');
    btn.style.transform = options.classList.contains('show') ? 'rotate(45deg)' : 'rotate(0deg)';
  }

  function PL_JS_acaoRapida(acao) {
    google.script.run.PainelLateral_processarAcaoRapida(acao);
    PL_JS_toggleFab();
  }

  // ================================================================
  // UTILITÁRIOS DE UI
  // ================================================================

  /** Exibe/oculta o spinner de carregamento */
  function PL_JS_mostrarLoading(ativo) {
    document.getElementById('estadoLoading').classList.toggle('hidden', !ativo);
    if (ativo) document.getElementById('pautaContainer').classList.add('hidden');
  }

  /** Exibe mensagem de erro centralizada */
  function PL_JS_mostrarErro(msg) {
    PL_JS_mostrarLoading(false);
    document.getElementById('mensagemErro').textContent = msg || 'Erro desconhecido.';
    document.getElementById('estadoErro').classList.remove('hidden');
  }

  /** Handler de erro padrão para google.script.run */
  function PL_JS_onErro(err) {
    PL_JS_mostrarErro(err && err.message ? err.message : String(err));
  }

  /**
   * Exibe um toast do Materialize com estilo OAB.
   * @param {string} msg
   * @param {'ok'|'erro'} tipo
   */
  function PL_JS_toast(msg, tipo) {
    M.toast({
      html:      msg,
      classes:   tipo === 'erro' ? 'toast-oab-erro' : 'toast-oab-ok',
      displayLength: 2500
    });
  }

  /** Escapa HTML para evitar XSS ao inserir dados da planilha no DOM */
  function PL_JS_esc(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g,  '&amp;')
      .replace(/</g,  '&lt;')
      .replace(/>/g,  '&gt;')
      .replace(/"/g,  '&quot;');
  }
</script>