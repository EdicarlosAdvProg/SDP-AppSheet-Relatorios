<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <?!= include('FormSessoes-style'); ?>
</head>

<body>

  <div class="main-container">

    <!-- Cabeçalho e Busca FIXO -->
    <div class="search-header-container">
      <div class="search-card z-depth-2">
        <div class="row" style="margin-bottom: 0;">
          <div class="input-field col s12">
            <i class="material-icons prefix">search</i>
            <input type="text" id="inputBuscaSessao" oninput="formSessoes_filtrar()" autocomplete="off">
            <label for="inputBuscaSessao">Pesquisar por data, órgão ou local...</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de Sessões -->
    <div class="list-wrapper">
      <div id="loaderLista" class="center-align" style="padding: 20px; display: none;">
        <div class="preloader-wrapper small active">
          <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="listaSessoes" class="collection" style="border: none;"></div>
    </div>

    <!-- FAB principal -->
    <div class="fixed-action-btn">
      <a class="btn-floating btn-large btn-oab-red">
        <i class="large material-icons">menu</i>
      </a>
      <ul>
        <li>
          <a class="btn-floating btn-oab-red tooltipped btn-hover-zoom" data-position="left"
            data-tooltip="Criar Pauta (em breve)" onclick="formSessoes_emBreve('Criação de Pauta')">
            <i class="material-icons">assignment</i>
          </a>
        </li>
        <li>
          <a class="btn-floating btn-oab-red tooltipped btn-hover-zoom" data-position="left"
            data-tooltip="Criar Ata (em breve)" onclick="formSessoes_emBreve('Geração de Ata')">
            <i class="material-icons">description</i>
          </a>
        </li>
        <li>
          <a class="btn-floating btn-oab-red tooltipped btn-hover-zoom" data-position="left" data-tooltip="Nova Sessão"
            onclick="formSessoes_abrirNova()">
            <i class="material-icons">add</i>
          </a>
        </li>
        <li>
          <a class="btn-floating btn-oab-red tooltipped btn-hover-zoom" data-position="left"
            data-tooltip="Sincronizar lista" onclick="formSessoes_carregar()">
            <i class="material-icons">refresh</i>
          </a>
        </li>
      </ul>
    </div>

  </div><!-- /main-container -->


  <!-- ==================================================================
       MODAL: CADASTRO / EDIÇÃO DE SESSÃO
  ================================================================== -->
  <div id="modalSessaoCad" class="modal modal-sessao-cad">
    <div class="modal-content">
      <h5 id="sessaoModalTitulo">Nova Sessão</h5>
      <form id="sessaoForm" autocomplete="off">
        <input type="hidden" id="sess_f_Id">

        <div class="row" style="margin-bottom: 0;">
          <div class="input-field col s12 m4">
            <input id="sess_f_Data" type="text" class="datepicker" readonly>
            <label for="sess_f_Data">Data da Sessão *</label>
          </div>
          <div class="input-field col s12 m8">
            <select id="sess_f_Orgao">
              <option value="" disabled selected>Selecione o órgão *</option>
              <option value="Órgão Deliberativo do SDP">Órgão Deliberativo do SDP</option>
              <option value="Pleno do SDP">Pleno do SDP</option>
            </select>
            <label>Órgão Deliberativo *</label>
          </div>
        </div>

        <div class="row" style="margin-bottom: 0;">
          <div class="input-field col s12">
            <input id="sess_f_Local" type="text">
            <label for="sess_f_Local">Local / Sala</label>
          </div>
        </div>

        <div class="row" style="margin-bottom: 0;">
          <div class="input-field col s12 m6">
            <input id="sess_f_Presidente" type="text" class="autocomplete">
            <label for="sess_f_Presidente">Presidente da Sessão</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="sess_f_Secretario" type="text" class="autocomplete">
            <label for="sess_f_Secretario">Secretário(a)</label>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="modal-close waves-effect waves-grey btn-flat grey-text text-darken-1"
        style="margin-right: 10px;">Cancelar</button>
      <button id="sessBtnSalvar" class="waves-effect waves-light btn btn-salvar-modal" onclick="formSessoes_salvar()">
        <i class="material-icons left">save</i>Salvar
      </button>
    </div>
  </div>


  <!-- ==================================================================
       MODAL: FICHAS DE VOTAÇÃO (PAINEL DIVIDIDO)
  ================================================================== -->
  <div id="modalFichas" class="modal modal-fichas">
    <div class="modal-content">

      <!-- Cabeçalho fixo -->
      <div class="fichas-header">
        <div>
          <h5 id="fichasModalTitulo">Fichas de Votação</h5>
          <span id="fichasModalSubtitulo" class="grey-text"
            style="font-size: 0.8rem; display:block; margin-top: 2px;"></span>
        </div>
        <button class="modal-close waves-effect waves-grey btn-flat grey-text" style="padding: 0 8px;">
          <i class="material-icons">close</i>
        </button>
      </div>

      <!-- Corpo dividido -->
      <div class="fichas-body">

        <!-- PAINEL ESQUERDO: Lista de processos pautados -->
        <div class="fichas-painel-esq">
          <div class="fichas-painel-titulo">
            <i class="material-icons" style="font-size:15px;">gavel</i>
            Processos pautados
            <span id="fichasContagem" class="badge-count">0</span>
          </div>
          <div id="fichasListaProcessos" class="fichas-lista-proc">
            <!-- Renderizado via JS -->
          </div>
        </div>

        <!-- PAINEL DIREITO: Detalhes da ficha selecionada -->
        <div class="fichas-painel-dir" id="fichasPainelDir">

          <!-- Estado vazio -->
          <div id="fichasVazio" class="fichas-vazio-msg">
            <i class="material-icons"
              style="font-size: 48px; color: #ddd; display:block; margin-bottom: 12px;">touch_app</i>
            <p>Selecione um processo ao lado para visualizar a ficha de votação.</p>
          </div>

          <!-- Conteúdo da ficha (exibido ao selecionar um processo) -->
          <div id="fichasConteudo" style="display: none;">

            <!-- Cabeçalho azul: info do processo (fixo no topo) -->
            <div class="ficha-proc-info">
              <div class="ficha-proc-numero" id="fichaNumProc">---</div>
              <div class="ficha-proc-req" id="fichaReqProc">---</div>
              <div class="ficha-proc-local" id="fichaLocalProc"></div>
              <span id="fichaStatusChip" class="ficha-status-chip" style="display:none;"></span>
            </div>

            <!-- Área scrollável única: campos + label + formulário + votos -->
            <div class="fichas-dir-scroll">

              <!-- Campos editáveis: relator e expediente -->
              <div class="ficha-campos">
                <input type="hidden" id="ficha_f_Id">
                <input type="hidden" id="ficha_f_IdProcesso">

                <div class="row" style="margin-bottom: 0; margin-top: 8px;">
                  <div class="input-field col s12 m2">
                    <input id="ficha_f_Ordem" type="number" min="1">
                    <label for="ficha_f_Ordem">Ordem</label>
                  </div>
                  
                  <div class="input-field col s12 m6">
                    <input id="ficha_f_Relator" type="text" class="autocomplete">
                    <label for="ficha_f_Relator">Relator(a)</label>
                  </div>
                  
                  <div class="col s12 m4" style="padding-top: 18px; text-align:right;">
                    <button class="btn btn-small btn-oab-gold waves-effect waves-light"
                      onclick="formSessoes_salvarFicha()">
                      <i class="material-icons left" style="font-size:15px;">save</i>Salvar
                    </button>
                  </div>
                </div>

                <div class="row" style="margin-bottom: 0;">
                  <div class="input-field col s12">
                    <textarea id="ficha_f_Expediente" class="materialize-textarea"
                      style="min-height:40px; font-size: 0.88rem;"></textarea>
                    <label for="ficha_f_Expediente">Expediente / Observações</label>
                  </div>
                </div>
              </div>

              <!-- Label da seção votos -->
              <div class="ficha-secao-votos">
                <span>Votos registrados</span>
                <span id="fichaVotosTotal" class="ficha-secao-votos-total">0 voto(s)</span>
              </div>

              <!-- Formulário de novo voto (aparece ao clicar no FAB) -->
              <div id="painelNovoVoto" style="display: none;">
                <div class="painel-novo-voto">
                  <div class="painel-novo-voto-titulo">
                    <span><i class="material-icons"
                        style="font-size:14px; vertical-align:middle; margin-right:4px;">how_to_vote</i>Novo Voto</span>
                    <button class="btn-flat btn-small grey-text" style="padding: 0;"
                      onclick="formSessoes_fecharNovoVoto()">
                      <i class="material-icons" style="font-size:18px;">close</i>
                    </button>
                  </div>

                  <input type="hidden" id="voto_f_Id">

                  <div class="row" style="margin-bottom: 0;">
                    <div class="input-field col s12 m5">
                      <select id="voto_f_Tipo">
                        <option value="" disabled selected>Selecione *</option>
                        <option value="Voto do relator">Voto do relator</option>
                        <option value="Voto divergente">Voto divergente</option>
                      </select>
                      <label>Tipo de Voto *</label>
                    </div>
                    <div class="input-field col s12 m7">
                      <input id="voto_f_Relator" type="text" class="autocomplete">
                      <label for="voto_f_Relator">Votante (Membro)</label>
                    </div>
                  </div>

                  <div class="row" style="margin-bottom: 0;">
                    <div class="input-field col s12">
                      <textarea id="voto_f_Voto" class="materialize-textarea"
                        style="min-height: 60px; font-size: 0.88rem;"></textarea>
                      <label for="voto_f_Voto">Voto (texto)</label>
                    </div>
                  </div>

                  <div class="row" style="margin-bottom: 0;">
                    <div class="input-field col s12 m4">
                      <input id="voto_f_Resultado" type="number" min="0">
                      <label for="voto_f_Resultado">Resultado (placar)</label>
                    </div>
                  </div>

                  <!-- Área de upload do PDF -->
                  <div class="upload-area" id="uploadAreaVoto" onclick="document.getElementById('inputPDFVoto').click()"
                    style="border: 2px dashed #a68945; padding: 15px; text-align: center; cursor: pointer; border-radius: 8px; margin-bottom: 15px;">
                    <i class="material-icons" style="color: #a68945; font-size: 32px;">upload_file</i>
                    <p style="margin: 5px 0;">
                      <strong id="labelUploadVoto">Clique para anexar o relatório em PDF</strong><br>
                      <span style="font-size: 0.8rem; color: #777;">Opcional · PDF único</span>
                    </p>
                  </div>
                  <input type="file" id="inputPDFVoto" accept=".pdf" style="display:none;"
                    onchange="formSessoes_selecionarPDF(this)">

                  <div class="right-align" style="padding-bottom: 10px;">
                    <button class="btn btn-oab-blue waves-effect waves-light" onclick="formSessoes_salvarVoto()">
                      <i class="material-icons left">save</i>Salvar Voto
                    </button>
                  </div>
                </div>
              </div><!-- /painelNovoVoto -->

              <!-- Lista de votos em accordion -->
              <div id="fichasListaVotos" class="votos-lista">
                <!-- Renderizado via JS -->
              </div>

            </div><!-- /fichas-dir-scroll -->

          </div><!-- /fichasConteudo -->

          <!-- FAB: filho direto de fichas-painel-dir para ficar ancorado ao painel, fora do scroll -->
          <div class="fichas-fab-interno" id="fichasFabInterno">
            <div class="fichas-fab-opcoes">
              <div class="fichas-fab-opcao" onclick="formSessoes_abrirUploadAvulso()">
                <span class="fichas-fab-opcao-label">Enviar PDF avulso</span>
                <button class="fichas-fab-opcao-btn cor-dourado">
                  <i class="material-icons" style="font-size:18px;">picture_as_pdf</i>
                </button>
              </div>
              <div class="fichas-fab-opcao" onclick="formSessoes_abrirNovoVoto()">
                <span class="fichas-fab-opcao-label">Adicionar voto</span>
                <button class="fichas-fab-opcao-btn cor-azul">
                  <i class="material-icons" style="font-size:18px;">how_to_vote</i>
                </button>
              </div>
            </div>
            <button class="fichas-fab-btn-principal" onclick="formSessoes_toggleFab()">
              <i class="material-icons">add</i>
            </button>
          </div>

        </div><!-- /fichas-painel-dir -->
      </div><!-- /fichas-body -->

    </div><!-- /modal-content -->
  </div><!-- /modalFichas -->

  <!-- Input de PDF avulso (sem voto vinculado) -->
  <input type="file" id="inputPDFAvulso" accept=".pdf" style="display:none;"
    onchange="formSessoes_processarPDFAvulso(this)">


  <!-- ==================================================================
       MODAL: CONFIRMAÇÃO GENÉRICA
  ================================================================== -->
  <div id="modalConfirmacao" class="modal modal-pequena">
    <div class="modal-content center-align">
      <i id="iconConfirmacao" class="material-icons large red-text text-darken-2"
        style="font-size: 52px; margin-bottom: 8px;">delete_forever</i>
      <h5 id="tituloConfirmacao" style="border-left:none; color:#c62828; text-align:center;">
        Confirmar exclusão
      </h5>
      <p id="msgConfirmacao" style="color:#555; font-size:0.9rem; white-space:pre-line;">
        Esta ação não pode ser desfeita.
      </p>
    </div>
    <div class="modal-footer" style="justify-content: center; gap: 12px; padding-bottom: 20px !important;">
      <button class="modal-close waves-effect waves-grey btn-flat grey lighten-4"
        style="border-radius: 50px;">Cancelar</button>
      <button id="btnConfirmarAcao" class="waves-effect waves-light btn"
        style="background:#c62828; border-radius:50px; font-weight:700;">
        Confirmar
      </button>
    </div>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <?!= include('FormSessoes-js'); ?>

</body>

</html>