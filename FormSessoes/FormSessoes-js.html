<script>
  /**
   * Frontend — FormSessoes
   * SDP OAB/GO — Gestão de Sessões
   */

  // ============================================================
  // ESTADO GLOBAL
  // ============================================================
  let baseSessoes = [];
  let baseMembros = {};
  let sessaoDataISO = '';
  let fichaAtualId = '';
  let fichaAtualIdProc = '';
  let pdfSelecionado = null; // { file, base64 } do PDF do novo voto

  const MESES_PT = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

  // ============================================================
  // INICIALIZAÇÃO
  // ============================================================
  document.addEventListener('DOMContentLoaded', function () {
    M.AutoInit();
    M.FloatingActionButton.init(document.querySelectorAll('.fixed-action-btn'), { hoverEnabled: true });

    ['modalConfirmacao'].forEach(id => {
      const el = document.getElementById(id);
      if (el) M.Modal.init(el, { dismissible: false });
    });

    const elFichas = document.getElementById('modalFichas');
    if (elFichas) M.Modal.init(elFichas, { dismissible: true });

    formSessoes_carregar();
  });

  // ============================================================
  // CARREGAMENTO E RENDERIZAÇÃO DA LISTA DE SESSÕES
  // ============================================================

  function formSessoes_carregar() {
    const loader = document.getElementById('loaderLista');
    const container = document.getElementById('listaSessoes');
    loader.style.display = 'block';
    container.style.opacity = '0.4';

    google.script.run
      .withSuccessHandler(function (res) {
        loader.style.display = 'none';
        container.style.opacity = '1';
        if (res.sucesso) {
          baseSessoes = res.sessoes || [];
          baseMembros = res.membros || {};
          formSessoes_renderizar(baseSessoes);
        } else {
          M.toast({ html: 'Erro ao carregar: ' + res.erro, classes: 'red darken-2' });
        }
      })
      .withFailureHandler(function () {
        loader.style.display = 'none';
        container.style.opacity = '1';
        M.toast({ html: 'Falha crítica no servidor.', classes: 'red darken-2' });
      })
      .formSessoes_buscarDadosCompletos();
  }

  function formSessoes_renderizar(lista) {
  const container = document.getElementById('listaSessoes');
  container.innerHTML = '';

  if (!lista || lista.length === 0) {
    container.innerHTML = `
        <div class="lista-vazia-msg">
          <i class="material-icons">event_busy</i>
          <p>Nenhuma sessão encontrada para esta busca.</p>
        </div>`;
    return;
  }

  lista.forEach(s => {
    const partes = s.datasessao && s.datasessao !== 'Data não informada'
      ? s.datasessao.split('/') : null;

    const dia = partes ? partes[0] : '--';
    const mes = partes ? (MESES_PT[parseInt(partes[1], 10) - 1] || '') : '';
    const ano = partes ? partes[2] : '';

    const idSafe = _esc(s.id);

    const card = document.createElement('div');
    card.className = 'collection-item-sessao';
    card.innerHTML = `
        <div class="sess-col-data">
          <span class="sess-data-dia">${dia}</span>
          <span class="sess-data-mes">${mes}</span>
          <span class="sess-data-ano">${ano}</span>
        </div>
        <div class="sess-col-info">
          <span class="sess-orgao">${s.orgao || 'Órgão não informado'}</span>
          
          <span class="sess-local">
            <i class="material-icons" style="font-size:13px; vertical-align:middle; margin-right:3px;">location_on</i>
            ${s.local || 'Local não informado'}
          </span>
          
          <span class="sess-participantes" style="display: block; margin-top: 2px;">
            <strong>Presidente da sessão: </strong>${s.presidente || 'Não informado'}
          </span>

          <span class="sess-participantes" style="display: block; margin-top: 2px;">
            <strong>Secretário da mesa: </strong>${s.secretario || 'Não informado'}
          </span>
        </div>
        <div class="sess-col-metricas">
          <span class="sess-metrica-num">${s.totalFichas}</span>
          <span class="sess-metrica-label">Processo${s.totalFichas !== 1 ? 's' : ''}<br>pautado${s.totalFichas !== 1 ? 's' : ''}</span>
        </div>
        <div class="sess-col-actions">
          <i class="material-icons act-btn c-fichas tooltipped"
             data-tooltip="Fichas de Votação"
             onclick="formSessoes_abrirFichas('${idSafe}')">ballot</i>
          <i class="material-icons act-btn c-edit tooltipped"
             data-tooltip="Editar Sessão"
             onclick="formSessoes_abrirEditar('${idSafe}')">edit</i>
          <i class="material-icons act-btn c-del tooltipped"
             data-tooltip="Excluir Sessão"
             onclick="formSessoes_confirmarExclusao('${idSafe}', '${_esc(s.datasessao)}')">delete</i>
        </div>
      `;
    container.appendChild(card);
  });

  M.Tooltip.init(document.querySelectorAll('.tooltipped'));
}

  // ============================================================
  // FILTRO
  // ============================================================

  function formSessoes_filtrar() {
    const termo = (document.getElementById('inputBuscaSessao').value || '').toLowerCase().trim();
    if (!termo) { formSessoes_renderizar(baseSessoes); return; }

    const filtrados = baseSessoes.filter(s =>
      (s.datasessao || '').toLowerCase().includes(termo) ||
      (s.orgao || '').toLowerCase().includes(termo) ||
      (s.local || '').toLowerCase().includes(termo) ||
      (s.presidente || '').toLowerCase().includes(termo) ||
      (s.secretario || '').toLowerCase().includes(termo)
    );
    formSessoes_renderizar(filtrados);
  }

  // ============================================================
  // MODAL DE CADASTRO / EDIÇÃO DE SESSÃO
  // ============================================================

  function formSessoes_abrirNova() {
    document.getElementById('sessaoForm').reset();
    document.getElementById('sess_f_Id').value = '';
    document.getElementById('sessaoModalTitulo').innerText = 'Nova Sessão';
    sessaoDataISO = '';
    _initDatepickerSessao('');
    M.FormSelect.init(document.querySelectorAll('#modalSessaoCad select'));
    _autocompleteMembrosSessao();
    M.updateTextFields();
    _abrirModal('modalSessaoCad');
  }

  function formSessoes_abrirEditar(id) {
    const s = baseSessoes.find(x => x.id === id);
    if (!s) return M.toast({ html: 'Sessão não encontrada.', classes: 'orange darken-3' });

    document.getElementById('sessaoForm').reset();
    document.getElementById('sessaoModalTitulo').innerText = 'Editar Sessão';
    document.getElementById('sess_f_Id').value = s.id;
    document.getElementById('sess_f_Local').value = s.local || '';
    document.getElementById('sess_f_Presidente').value = s.presidente || '';
    document.getElementById('sess_f_Secretario').value = s.secretario || '';
    sessaoDataISO = s.dataiso || '';

    _initDatepickerSessao(s.datasessao || '');

    setTimeout(() => {
      const sel = document.getElementById('sess_f_Orgao');
      sel.value = s.orgao || '';
      M.FormSelect.init(sel);
    }, 80);

    _autocompleteMembrosSessao();
    M.updateTextFields();
    _abrirModal('modalSessaoCad');
  }

  function _initDatepickerSessao(valorExibido) {
    const el = document.getElementById('sess_f_Data');
    if (!el) return;
    const instAnterior = M.Datepicker.getInstance(el);
    if (instAnterior) instAnterior.destroy();
    M.Datepicker.init(el, {
      format: 'dd/mm/yyyy', autoClose: true, i18n: _i18nPtBR(),
      onSelect: function (d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        sessaoDataISO = `${y}-${m}-${day}`;
      }
    });
    if (valorExibido) { el.value = valorExibido; M.updateTextFields(); }
  }

  function _autocompleteMembrosSessao() {
    ['sess_f_Presidente', 'sess_f_Secretario'].forEach(id => {
      const el = document.getElementById(id);
      if (el) M.Autocomplete.init(el, { data: baseMembros, minLength: 2, limit: 7 });
    });
  }

  function formSessoes_salvar() {
    const orgao = document.getElementById('sess_f_Orgao').value;
    if (!orgao) return M.toast({ html: 'Selecione o Órgão Deliberativo.', classes: 'orange darken-3' });
    if (!sessaoDataISO) return M.toast({ html: 'Selecione a Data da Sessão.', classes: 'orange darken-3' });

    const btn = document.getElementById('sessBtnSalvar');
    btn.disabled = true;
    btn.innerHTML = 'Processando...';

    google.script.run
      .withSuccessHandler(function () {
        M.toast({ html: 'Sessão salva com sucesso!', classes: 'green darken-2' });
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons left">save</i>Salvar';
        M.Modal.getInstance(document.getElementById('modalSessaoCad')).close();
        formSessoes_carregar();
      })
      .withFailureHandler(function (err) {
        M.toast({ html: 'Erro: ' + err.message, classes: 'red darken-2' });
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons left">save</i>Salvar';
      })
      .formSessoes_salvarRegistro({
        id: document.getElementById('sess_f_Id').value || '',
        datasessao: sessaoDataISO,
        orgao: orgao,
        local: document.getElementById('sess_f_Local').value,
        presidente: document.getElementById('sess_f_Presidente').value,
        secretario: document.getElementById('sess_f_Secretario').value
      });
  }

  // ============================================================
  // EXCLUSÃO DE SESSÃO
  // ============================================================

  function formSessoes_confirmarExclusao(id, data) {
    document.getElementById('msgConfirmacao').innerText =
      `A sessão de ${data} será removida permanentemente.\n\nOs processos pautados e votos vinculados serão preservados.\nEsta ação não pode ser desfeita.`;

    const btnConf = document.getElementById('btnConfirmarAcao');
    const novoBtn = btnConf.cloneNode(true);
    novoBtn.innerHTML = 'Excluir Sessão';
    btnConf.parentNode.replaceChild(novoBtn, btnConf);
    novoBtn.onclick = function () {
      M.Modal.getInstance(document.getElementById('modalConfirmacao')).close();
      google.script.run
        .withSuccessHandler(function () {
          M.toast({ html: 'Sessão excluída.', classes: 'blue-grey darken-2' });
          formSessoes_carregar();
        })
        .withFailureHandler(function (err) {
          M.toast({ html: 'Erro: ' + err.message, classes: 'red darken-2' });
        })
        .formSessoes_excluirRegistro(id);
    };
    _abrirModal('modalConfirmacao');
  }

  // ============================================================
  // MODAL DE FICHAS DE VOTAÇÃO
  // ============================================================

  function formSessoes_abrirFichas(idSessao) {
    fichaAtualId = '';
    fichaAtualIdProc = '';
    pdfSelecionado = null;

    const sessao = baseSessoes.find(s => s.id === idSessao);
    document.getElementById('fichasModalTitulo').textContent = 'Fichas de Votação';
    document.getElementById('fichasModalSubtitulo').textContent =
      sessao ? `${sessao.orgao} · ${sessao.datasessao}` : '';

    _fichasPainelVazio();
    _fecharFab();

    document.getElementById('fichasListaProcessos').innerHTML = `
      <div style="text-align:center; padding: 30px;">
        <div class="preloader-wrapper small active">
          <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left"><div class="circle"></div></div>
            <div class="gap-patch"><div class="circle"></div></div>
            <div class="circle-clipper right"><div class="circle"></div></div>
          </div>
        </div>
      </div>`;

    _abrirModal('modalFichas');

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res.sucesso) {
          document.getElementById('fichasListaProcessos').innerHTML =
            `<div style="padding:20px; color:#c62828; font-size:0.85rem;">${res.erro}</div>`;
          return;
        }
        _renderizarListaFichas(res.fichas || []);
      })
      .withFailureHandler(function (err) {
        document.getElementById('fichasListaProcessos').innerHTML =
          `<div style="padding:20px; color:#c62828; font-size:0.85rem;">Erro: ${err.message}</div>`;
      })
      .formSessoes_buscarFichas(idSessao);
  }

  function _renderizarListaFichas(fichas) {
    const container = document.getElementById('fichasListaProcessos');
    document.getElementById('fichasContagem').textContent = fichas.length;

    if (!fichas || fichas.length === 0) {
      container.innerHTML = `
          <div style="padding:30px; text-align:center; color:#bbb; font-size:0.85rem;">
            <i class="material-icons" style="font-size:36px; display:block; margin-bottom:8px; color:#ddd;">gavel</i>
            Nenhum processo pautado nesta sessão.
          </div>`;
      return;
    }

    // --- ORDENAÇÃO PELO CAMPO [ORDEM] ---
    fichas.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

    container.innerHTML = '';
    fichas.forEach((f, idx) => {
      const item = document.createElement('div');
      item.className = 'ficha-proc-item';
      item.setAttribute('data-ficha-id', f.id);

      const reqShort = (f.proc.requerente || '').substring(0, 55);
      const statusCfg = _statusCor(f.proc.status);

      // Adicionado o número da ordem (#) antes do número do processo
      item.innerHTML = `
          <span class="ficha-proc-num">
            <span style="color: #a68945; font-weight: bold; margin-right: 4px;">#${f.ordem}</span> 
            ${f.proc.numero || 'S/N'}
          </span>
          <span class="ficha-proc-req-short" title="${_esc(f.proc.requerente)}">${reqShort || 'Requerente não informado'}</span>
          ${f.proc.status ? `<span class="ficha-proc-status-mini ${statusCfg}">${f.proc.status}</span>` : ''}
        `;

      item.onclick = function () {
        document.querySelectorAll('.ficha-proc-item').forEach(el => el.classList.remove('selecionado'));
        this.classList.add('selecionado');
        _carregarPainelFicha(f);
      };

      container.appendChild(item);

      // Seleciona o primeiro da lista ordenada automaticamente
      if (idx === 0) setTimeout(() => item.click(), 120);
    });
  }

  // Variável global para controle de alteração
  let fichaSelecionadaOriginal = null; 

  /**
   * Carrega os dados da ficha no painel lateral direito
   * Une a limpeza de estado de ontem com a lógica de ordem de hoje.
   */
  function _carregarPainelFicha(ficha) {
      // 1. Definição de IDs globais
      fichaAtualId = ficha.id;
      fichaAtualIdProc = ficha.idprocesso;
      
      // 2. Limpeza de estado (Crucial para que o sistema não trave ao trocar de ficha)
      pdfSelecionado = null; 
      
      // 3. Armazena a ficha completa como original para comparações de Ordem futuras
      fichaSelecionadaOriginal = JSON.parse(JSON.stringify(ficha)); 

      // 4. Preenchimento da interface (Cabeçalho azul)
      document.getElementById('fichaNumProc').textContent = `Processo nº ${ficha.proc.numero || 'S/N'}`;
      document.getElementById('fichaReqProc').textContent = ficha.proc.requerente || 'Requerente não informado';
      document.getElementById('fichaLocalProc').textContent = ficha.proc.local || '';

      const chip = document.getElementById('fichaStatusChip');
      chip.textContent = ficha.proc.status || '';
      chip.style.display = ficha.proc.status ? 'inline-block' : 'none';

      // 5. Preenchimento dos campos do formulário
      document.getElementById('ficha_f_Id').value = ficha.id;
      document.getElementById('ficha_f_IdProcesso').value = ficha.idprocesso;
      document.getElementById('ficha_f_Ordem').value = ficha.ordem || '';
      document.getElementById('ficha_f_Relator').value = ficha.relator || '';
      document.getElementById('ficha_f_Expediente').value = ficha.expediente || '';

      // 6. Inicialização de componentes Materialize
      M.Autocomplete.init(document.getElementById('ficha_f_Relator'), {
        data: baseMembros, 
        minLength: 2, 
        limit: 7
      });
      M.updateTextFields();
      M.textareaAutoResize(document.getElementById('ficha_f_Expediente'));

      // 7. Reset de interface
      formSessoes_fecharNovoVoto(); // Fecha o formulário de "Novo Voto" se estiver aberto
      _fecharFab();                 // Fecha o menu flutuante (bolinha +)
      _fichasExibirConteudo();      // Esconde a mensagem "Selecione um processo" e mostra a ficha

      // 8. CARREGAMENTO DOS VOTOS
      // Certifique-se de que no seu HTML só existe UM elemento com id="fichasListaVotos"
      _carregarVotos(ficha.id);
  }

  function _fichasPainelVazio() {
    document.getElementById('fichasVazio').style.display = 'flex';
    document.getElementById('fichasConteudo').style.display = 'none';
  }

  function _fichasExibirConteudo() {
    document.getElementById('fichasVazio').style.display = 'none';
    document.getElementById('fichasConteudo').style.display = 'flex';
  }

  // ============================================================
  // SALVAR FICHA (RELATOR + EXPEDIENTE)
  // ============================================================

  /**
   * Função principal de salvamento. 
   * Decide se chama a reordenação ou apenas o salvamento simples.
   */
  function formSessoes_salvarFicha() {
      const id = document.getElementById('ficha_f_Id').value;
      const novaOrdem = parseInt(document.getElementById('ficha_f_Ordem').value);
      const ordemAntiga = parseInt(fichaSelecionadaOriginal.ordem);
      const idSessao = fichaSelecionadaOriginal.idsessao; // Garantir que idsessao venha no objeto da ficha

      if (!id) return M.toast({ html: 'Nenhuma ficha selecionada.', classes: 'orange darken-3' });

      M.toast({ html: 'Processando alterações...', classes: 'blue' });

      // 1. Verifica se houve alteração na ordem
      const ordemAlterada = (novaOrdem !== ordemAntiga);

      if (ordemAlterada) {
          // Fluxo com reordenação
          google.script.run
              .withSuccessHandler(function() {
                  // Após reordenar, salva os outros campos
                  executarSalvarSimples(id, true); 
              })
              .withFailureHandler(err => M.toast({ html: 'Erro na reordenação: ' + err.message, classes: 'red' }))
              .formSessoes_atualizarOrdemFichas(idSessao, id, novaOrdem, ordemAntiga);
      } else {
          // Fluxo simples (apenas texto)
          executarSalvarSimples(id, false);
      }
  }

  /**
   * Função auxiliar para salvar Relator e Expediente
   * @param {string} id
   * @param {boolean} recarregarTudo Se true, recarrega a lista de fichas completa
   */
  function executarSalvarSimples(id, recarregarTudo) {
      const dados = {
          id: id,
          relator: document.getElementById('ficha_f_Relator').value,
          expediente: document.getElementById('ficha_f_Expediente').value
      };

      google.script.run
          .withSuccessHandler(function() {
              M.toast({ html: 'Ficha salva com sucesso!', classes: 'green' });
              
              // Se a ordem mudou, precisamos buscar as fichas da sessão de novo para atualizar a lista lateral
              if (recarregarTudo) {
                google.script.run
                  .withSuccessHandler(res => {
                      if (res.sucesso) {
                          _renderizarListaFichas(res.fichas);
                          // Mantém a ficha atual selecionada visualmente
                          setTimeout(() => {
                            const item = document.querySelector(`.ficha-proc-item[data-ficha-id="${id}"]`);
                            if(item) item.classList.add('selecionado');
                          }, 200);
                      }
                  })
                  .formSessoes_buscarFichas(fichaSelecionadaOriginal.idsessao);
              }
          })
          .withFailureHandler(err => M.toast({ html: 'Erro ao salvar: ' + err.message, classes: 'red' }))
          .formSessoes_salvarFicha(dados);
  }

  // ============================================================
  // FAB INTERNO
  // ============================================================

  function formSessoes_toggleFab() {
    const fab = document.getElementById('fichasFabInterno');
    fab.classList.toggle('aberto');
  }

  function _fecharFab() {
    const fab = document.getElementById('fichasFabInterno');
    if (fab) fab.classList.remove('aberto');
  }

  // Ação 1: Abrir formulário de novo voto (rola para ele)
  function formSessoes_abrirNovoVoto() {
    _fecharFab();

    if (!fichaAtualId) return M.toast({ html: 'Selecione um processo primeiro.', classes: 'orange darken-3' });

    const painel = document.getElementById('painelNovoVoto');
    painel.style.display = 'block';

    // Reseta o formulário
    document.getElementById('voto_f_Id').value = '';
    pdfSelecionado = null;
    const uploadArea = document.getElementById('uploadAreaVoto');
    uploadArea.className = 'upload-area';
    uploadArea.innerHTML = `
      <i class="material-icons">upload_file</i>
      <p><strong>Clique para anexar o relatório em PDF</strong><br>Opcional · máx. 15 MB</p>`;

    M.FormSelect.init(document.querySelectorAll('#painelNovoVoto select'));
    M.Autocomplete.init(document.getElementById('voto_f_Relator'), {
      data: baseMembros, minLength: 2, limit: 7
    });
    M.updateTextFields();

    // Rola para o formulário
    setTimeout(() => {
      painel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 60);
  }

  function formSessoes_fecharNovoVoto() {
    const painel = document.getElementById('painelNovoVoto');
    if (painel) painel.style.display = 'none';
    pdfSelecionado = null;
  }

  // Ação 2: Upload de PDF avulso (sem criar voto)
  function formSessoes_abrirUploadAvulso() {
    _fecharFab();
    if (!fichaAtualId) return M.toast({ html: 'Selecione um processo primeiro.', classes: 'orange darken-3' });
    document.getElementById('inputPDFAvulso').click();
  }

  // ============================================================
  // VOTOS
  // ============================================================

  function _carregarVotos(idFicha) {
    const container = document.getElementById('fichasListaVotos');
    if (!container) {
        return;
    }

    // Exibe loader
    container.innerHTML = `
        <div class="votos-vazio">
            <div class="preloader-wrapper small active">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left"><div class="circle"></div></div>
                    <div class="gap-patch"><div class="circle"></div></div>
                    <div class="circle-clipper right"><div class="circle"></div></div>
                </div>
            </div>
        </div>`;

    google.script.run
        .withSuccessHandler(function (res) {
            if (!res.sucesso) {
                console.error('Erro retornado pelo servidor:', res.erro);
                container.innerHTML = `<div class="votos-vazio">Erro: ${res.erro || 'desconhecido'}</div>`;
                return;
            }
            _renderizarVotos(res.votos || []);
        })
        .withFailureHandler(function (err) {
            console.error('Falha na comunicação com o servidor:', err);
            container.innerHTML = `<div class="votos-vazio">Falha na comunicação.</div>`;
        })
        .formSessoes_buscarVotos(idFicha);
  }

  function _renderizarVotos(votos) {
    const container = document.getElementById('fichasListaVotos');
    if (!container) {
        return;
    }

    // Atualiza contador de votos
    const totalSpan = document.getElementById('fichaVotosTotal');
    if (totalSpan) {
        totalSpan.textContent = `${votos.length} voto${votos.length !== 1 ? 's' : ''}`;
    } else {
        console.warn('Elemento #fichaVotosTotal não encontrado');
    }

    // Se não há votos, exibe mensagem vazia
    if (!votos || votos.length === 0) {
        container.innerHTML = `
            <div class="votos-vazio">
                <i class="material-icons" style="font-size:32px; display:block; margin-bottom:8px; color:#ddd;">how_to_vote</i>
                Nenhum voto registrado. Use o botão + para adicionar.
            </div>`;
        return;
    }

    // Limpa o container antes de renderizar
    container.innerHTML = '';

    const tipoOpcoes = ['Voto do relator', 'Voto divergente'];

    votos.forEach((v, index) => {
        const tipoClass = _votoTipoClasse(v.tipovoto);
        const idSafe = _esc(v.id);

        // Tenta encontrar a URL em todas as variações possíveis vindas do backend
        const linkRelatorio = v.urlvoto || v.urlRelatorio || v['URL Relatório'] || v.url_voto || '';

        const resultadoExibe = (v.resultado !== '' && v.resultado !== null && v.resultado !== undefined)
            ? v.resultado : '—';

        // Define a seção do PDF
        const secaoRelatorio = linkRelatorio
            ? `<div class="voto-campo-grupo" style="margin-top: 4px;">
                <label class="voto-campo-label">Relatório</label>
                <div class="voto-pdf-container">
                    <a href="${_esc(linkRelatorio)}" target="_blank" class="voto-pdf-link">
                        <i class="material-icons">picture_as_pdf</i>Abrir relatório
                    </a>
                    <button class="btn-pdf-excluir tooltipped" data-tooltip="Excluir arquivo"
                        onclick="formSessoes_removerRelatorio('${idSafe}', '${_esc(linkRelatorio)}')">
                        <i class="material-icons" style="font-size:16px;">delete</i>
                    </button>
                </div>
            </div>`
            : `<div class="voto-campo-grupo" style="margin-top: 4px;">
                <label class="voto-campo-label">Relatório</label>
                <button class="btn-pdf-adicionar" onclick="formSessoes_adicionarRelatorioDireto('${idSafe}')">
                    <i class="material-icons" style="font-size:16px;">add_circle_outline</i>Anexar PDF
                </button>
            </div>`;

        const acc = document.createElement('div');
        acc.className = 'voto-accordion';
        acc.setAttribute('data-voto-id', v.id);

        const opsTipo = tipoOpcoes.map(o =>
            `<option value="${o}" ${v.tipovoto === o ? 'selected' : ''}>${o}</option>`).join('');

        // Usando _escTexto para campos textuais (exceto onde o HTML é necessário)
        acc.innerHTML = `
            <div class="voto-accordion-header" onclick="formSessoes_toggleVoto(this)">
                <span class="voto-tipo-chip ${tipoClass}">${_escTexto(v.tipovoto) || '—'}</span>
                <div class="voto-header-info">
                    <span class="voto-header-votante">${_escTexto(v.relator) || 'Relator não informado'}</span>
                </div>
                <span class="voto-resultado-placar" title="Resultado">${_escTexto(resultadoExibe)}</span>
                <i class="material-icons voto-chevron">expand_more</i>
            </div>

            <div class="voto-accordion-body">
                <div class="voto-campo-grupo">
                    <label class="voto-campo-label">TipoVoto</label>
                    <div class="input-field voto-campo-input">
                        <select id="ve_TipoVoto_${idSafe}">${opsTipo}</select>
                    </div>
                </div>

                <div class="voto-campo-grupo">
                    <label class="voto-campo-label">Relator</label>
                    <div class="input-field voto-campo-input">
                        <input id="ve_Relator_${idSafe}" type="text"
                            value="${_escTexto(v.relator)}" class="autocomplete">
                    </div>
                </div>

                <div class="voto-campo-grupo voto-campo-grupo-voto">
                    <label class="voto-campo-label" style="margin-top: 10px;">Voto</label>
                    <div class="input-field voto-campo-input">
                        <textarea id="ve_Voto_${idSafe}"
                            class="materialize-textarea voto-textarea">${_escTexto(v.voto)}</textarea>
                    </div>
                </div>

                <div class="voto-campo-grupo">
                    <label class="voto-campo-label">Resultado</label>
                    <span class="voto-resultado-placar voto-resultado-readonly">${_escTexto(resultadoExibe)}</span>
                </div>

                ${secaoRelatorio}

                <div class="voto-accordion-footer">
                    <button class="btn-voto-del"
                        onclick="formSessoes_excluirVoto('${idSafe}')">
                        <i class="material-icons" style="font-size:14px;">delete_outline</i>Excluir
                    </button>
                    <button class="btn-voto-salvar"
                        onclick="formSessoes_salvarVotoEdicao('${idSafe}')">
                        <i class="material-icons" style="font-size:14px;">save</i>Salvar alterações
                    </button>
                </div>
            </div>
        `;

        container.appendChild(acc);

        // Reinicializa os componentes do Materialize para o novo elemento
        M.FormSelect.init(acc.querySelectorAll('select'));
        M.Autocomplete.init(acc.querySelector(`#ve_Relator_${idSafe}`), {
            data: baseMembros, minLength: 2, limit: 7
        });
        M.textareaAutoResize(acc.querySelector(`#ve_Voto_${idSafe}`));
        M.Tooltip.init(acc.querySelectorAll('.tooltipped'));
    });

}

  function formSessoes_toggleVoto(header) {
    const acc = header.closest('.voto-accordion');
    const estaAberto = acc.classList.contains('aberto');
    // Fecha todos
    document.querySelectorAll('.voto-accordion.aberto').forEach(el => el.classList.remove('aberto'));
    // Abre o clicado (se estava fechado)
    if (!estaAberto) acc.classList.add('aberto');
  }

  /**
   * Salva as edições feitas nos campos de um voto já existente (dentro do accordion).
   * Não atualiza Resultado — esse campo é somente leitura no card.
   */
  function formSessoes_salvarVotoEdicao(id) {
    const selTipo = document.getElementById(`ve_TipoVoto_${id}`);
    const inpRelator = document.getElementById(`ve_Relator_${id}`);
    const taVoto = document.getElementById(`ve_Voto_${id}`);

    if (!selTipo || !inpRelator || !taVoto) {
      return M.toast({ html: 'Campos do voto não encontrados.', classes: 'orange darken-3' });
    }

    const tipovoto = selTipo.value;
    const relator = inpRelator.value;
    const voto = taVoto.value.trim();

    if (!tipovoto) {
      return M.toast({ html: 'TipoVoto é obrigatório.', classes: 'orange darken-3' });
    }

    const acc = document.querySelector(`.voto-accordion[data-voto-id="${id}"]`);
    const urlvoto = acc && acc.querySelector('.voto-pdf-link')
      ? acc.querySelector('.voto-pdf-link').href : '';

    google.script.run
      .withSuccessHandler(function () {
        M.toast({ html: 'Voto atualizado!', classes: 'green darken-2' });
        _carregarVotos(fichaAtualId);
      })
      .withFailureHandler(function (err) {
        M.toast({ html: 'Erro ao salvar: ' + err.message, classes: 'red darken-2' });
      })
      .formSessoes_salvarVoto({
        id: id,
        idfichavotacao: fichaAtualId,
        idprocesso: fichaAtualIdProc,
        tipovoto: tipovoto,
        relator: relator,
        voto: voto,
        resultado: '', // preservado no backend — não sobrescreve
        urlvoto: urlvoto
      });
  }

  function formSessoes_salvarVoto() {
    if (!fichaAtualId) return M.toast({ html: 'Selecione uma ficha primeiro.', classes: 'orange darken-3' });

    const tipo = document.getElementById('voto_f_Tipo').value;
    const voto = document.getElementById('voto_f_Voto').value.trim();

    if (!tipo) {
      return M.toast({ html: 'TipoVoto é obrigatório.', classes: 'orange darken-3' });
    }

    const obj = {
      id: document.getElementById('voto_f_Id').value || '',
      idfichavotacao: fichaAtualId,
      idprocesso: fichaAtualIdProc,
      tipovoto: tipo,
      relator: document.getElementById('voto_f_Relator').value,
      voto: voto,
      resultado: document.getElementById('voto_f_Resultado').value,
      urlvoto: ''
    };

    M.toast({ html: 'Salvando voto...', classes: 'blue darken-2' });

    google.script.run
      .withSuccessHandler(function (res) {
        const idVoto = res.id;

        // Se tem PDF selecionado, faz o upload agora
        if (pdfSelecionado && pdfSelecionado.base64) {
          M.toast({ html: 'Enviando PDF para o Drive...', classes: 'blue darken-2' });
          google.script.run
            .withSuccessHandler(function () {
              M.toast({ html: 'Voto e PDF salvos com sucesso!', classes: 'green darken-2' });
              formSessoes_fecharNovoVoto();
              _carregarVotos(fichaAtualId);
            })
            .withFailureHandler(function (err) {
              M.toast({ html: 'Voto salvo, mas erro no upload do PDF: ' + err.message, classes: 'orange darken-3' });
              formSessoes_fecharNovoVoto();
              _carregarVotos(fichaAtualId);
            })
            .formSessoes_uploadRelatorio(idVoto, pdfSelecionado.base64, pdfSelecionado.nome);
        } else {
          M.toast({ html: 'Voto salvo!', classes: 'green darken-2' });
          formSessoes_fecharNovoVoto();
          _carregarVotos(fichaAtualId);
        }
      })
      .withFailureHandler(function (err) {
        M.toast({ html: 'Erro ao salvar voto: ' + err.message, classes: 'red darken-2' });
      })
      .formSessoes_salvarVoto(obj);
  }

  function formSessoes_excluirVoto(idVoto) {
    if (!confirm('Remover este voto permanentemente?')) return;

    google.script.run
      .withSuccessHandler(function () {
        M.toast({ html: 'Voto removido.', classes: 'blue-grey darken-2' });
        _carregarVotos(fichaAtualId);
      })
      .withFailureHandler(function (err) {
        M.toast({ html: 'Erro: ' + err.message, classes: 'red darken-2' });
      })
      .formSessoes_excluirVoto(idVoto);
  }

  // ============================================================
  // SELEÇÃO E UPLOAD DE PDF
  // ============================================================

  /**
   * Chamado quando o usuário seleciona um PDF no input do formulário de novo voto.
   * Apenas armazena o arquivo em memória — o upload acontece ao salvar o voto.
   */
  function formSessoes_selecionarPDF(input) {
    const file = input.files[0];
    if (!file) return;

    if (file.type !== 'application/pdf') {
      return M.toast({ html: 'Selecione um arquivo PDF válido.', classes: 'red darken-2' });
    }
    if (file.size > 15 * 1024 * 1024) {
      return M.toast({ html: 'Arquivo muito grande. Limite: 15 MB.', classes: 'red darken-2' });
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      pdfSelecionado = {
        base64: e.target.result.split(',')[1],
        nome: file.name
      };

      // Atualiza a aparência da área de upload
      const uploadArea = document.getElementById('uploadAreaVoto');
      uploadArea.className = 'upload-area selecionado';
      uploadArea.innerHTML = `
        <i class="material-icons">check_circle</i>
        <p><strong>${file.name}</strong><br>${(file.size / 1024).toFixed(0)} KB selecionado</p>`;

      M.toast({ html: 'PDF pronto para envio.', classes: 'blue darken-2' });
    };
    reader.readAsDataURL(file);
    input.value = ''; // reseta para permitir selecionar o mesmo arquivo novamente
  }

  /**
   * Upload de PDF avulso — cria um voto do tipo "Relatório" automaticamente.
   */
  function formSessoes_processarPDFAvulso(input) {
    const file = input.files[0];
    if (!file) return;

    if (file.type !== 'application/pdf') {
      return M.toast({ html: 'Selecione um arquivo PDF válido.', classes: 'red darken-2' });
    }
    if (file.size > 15 * 1024 * 1024) {
      return M.toast({ html: 'Arquivo muito grande. Limite: 15 MB.', classes: 'red darken-2' });
    }

    M.toast({ html: 'Preparando envio...', classes: 'blue darken-2' });

    const reader = new FileReader();
    reader.onload = function (e) {
      const base64Data = e.target.result.split(',')[1];

      // Cria um voto "Relatório" para vincular o PDF
      google.script.run
        .withSuccessHandler(function (res) {
          google.script.run
            .withSuccessHandler(function () {
              M.toast({ html: 'PDF enviado e vinculado com sucesso!', classes: 'green darken-2' });
              input.value = '';
              _carregarVotos(fichaAtualId);
            })
            .withFailureHandler(function (err) {
              M.toast({ html: 'Erro no upload: ' + err.message, classes: 'red darken-2' });
            })
            .formSessoes_uploadRelatorio(res.id, base64Data, file.name);
        })
        .withFailureHandler(function (err) {
          M.toast({ html: 'Erro ao criar registro: ' + err.message, classes: 'red darken-2' });
        })
        .formSessoes_salvarVoto({
          id: '', idfichavotacao: fichaAtualId, idprocesso: fichaAtualIdProc,
          tipovoto: 'Relatório', relator: '', voto: 'Relatório em PDF', resultado: '', urlvoto: ''
        });
    };
    reader.readAsDataURL(file);
  }

  /**
   * Dispara o seletor de arquivos para um voto específico que não possui PDF
   */
  function formSessoes_adicionarRelatorioDireto(idVoto) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;

      // Validações básicas
      if (file.size > 15 * 1024 * 1024) return M.toast({ html: 'Limite de 15MB excedido', classes: 'red' });

      M.toast({ html: 'Fazendo upload do relatório...', classes: 'blue' });

      const reader = new FileReader();
      reader.onload = function (evt) {
        const base64Data = evt.target.result.split(',')[1];

        google.script.run
          .withSuccessHandler(function () {
            M.toast({ html: 'Relatório anexado!', classes: 'green' });
            _carregarVotos(fichaAtualId); // Recarrega a lista para mostrar o botão 'Abrir'
          })
          .withFailureHandler(err => M.toast({ html: err.message, classes: 'red' }))
          .formSessoes_uploadRelatorio(idVoto, base64Data, file.name);
      };
      reader.readAsDataURL(file);
    };
    input.click();
  }

  /**
   * Solicita a exclusão do arquivo do Drive e limpa o link na planilha
   */
  function formSessoes_removerRelatorio(idVoto, urlArquivo) {
    if (!confirm('Deseja realmente excluir este arquivo PDF permanentemente do Drive?')) return;

    M.toast({ html: 'Excluindo arquivo...', classes: 'amber darken-3' });

    google.script.run
      .withSuccessHandler(function () {
        M.toast({ html: 'Arquivo removido com sucesso.', classes: 'blue-grey' });
        _carregarVotos(fichaAtualId); // Recarrega para mostrar o botão de 'Anexar'
      })
      .withFailureHandler(err => M.toast({ html: err.message, classes: 'red' }))
      .formSessoes_excluirRelatorio(idVoto, urlArquivo);
  }

  // ============================================================
  // FUNCIONALIDADES EM DESENVOLVIMENTO
  // ============================================================

  function formSessoes_emBreve(funcionalidade) {
    M.toast({
      html: `<i class="material-icons left" style="line-height:inherit">construction</i>${funcionalidade} em desenvolvimento...`,
      classes: 'amber darken-4'
    });
  }

  // ============================================================
  // UTILITÁRIOS
  // ============================================================

  function _abrirModal(id) {
    const el = document.getElementById(id);
    const inst = M.Modal.getInstance(el) || M.Modal.init(el);
    inst.open();
  }

  function _esc(str) {
    return (str || '').toString()
      .replace(/\\/g, '\\\\')
      .replace(/'/g, "\\'")
      .replace(/"/g, '&quot;');
  }

  // Para conteúdo de textarea — escapa só os caracteres HTML sem quebrar o texto
  function _escTexto(str) {
    return (str || '').toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function _i18nPtBR() {
    return {
      cancel: 'Cancelar', clear: 'Limpar', done: 'OK',
      months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
      monthsShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
      weekdays: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
      weekdaysShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
      weekdaysAbbrev: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S']
    };
  }

  function _statusCor(status) {
    const mapa = {
      'Em tramitação': 's-tramitacao', 'Arquivado': 's-arquivado',
      'Deferido': 's-deferido', 'Indeferido': 's-indeferido',
      'Em recurso': 's-recurso', 'Em diligência': 's-diligencia',
      'Concluso': 's-concluso', 'Na secretaria': 's-secretaria'
    };
    return mapa[status] || 's-vazio';
  }

  function _votoTipoClasse(tipo) {
    const t = (tipo || '').toLowerCase();
    if (t.includes('relator')) return 'voto-tipo-relator';
    if (t.includes('membro')) return 'voto-tipo-membro';
    if (t.includes('minerva')) return 'voto-tipo-minerva';
    if (t.includes('vogal')) return 'voto-tipo-vogal';
    return 'voto-tipo-default';
  }
</script>