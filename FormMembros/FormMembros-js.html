<script>
  /**
   * Lógica Frontend do Cadastro de Membros
   */
  let baseDadosMembros = [];
  let listaCargosAutocomplete = {};

  document.addEventListener('DOMContentLoaded', function () {
    M.AutoInit();
    carregarMembrosJS();

    // Inicializa o Botão Flutuante com Menu
    var fab = document.querySelectorAll('.fixed-action-btn');
    M.FloatingActionButton.init(fab, {
      hoverEnabled: true, // Abre ao passar o mouse
      direction: 'top'    // Abre para cima
    });

    // Inicializa as Tooltips (Dicas de texto)
    var tooltips = document.querySelectorAll('.tooltipped');
    M.Tooltip.init(tooltips);

    // Garante que o listener seja removido se fechar no botão cancelar ou Esc
    const elem = document.getElementById('modalRapidoGenero');
    M.Modal.init(elem, {
      dismissible: false, // Impede fechar clicando fora (obriga a usar o botão 'Parar')
      onCloseEnd: () => {
        document.removeEventListener('keydown', escutaTecladoGenero);
      }
    });

  });

  // 1. Ouvinte de evento no campo Nome
  document.getElementById('f_Nome').addEventListener('blur', function() {
    // Formata o nome (Iniciais Maiúsculas e Preposições)
    //this.value = formatarNomeCompleto(this.value);
    
    const nomeDigitado = this.value;
    if (!nomeDigitado || nomeDigitado.trim().length < 5) return;

    // 2. Função Unificada: Busca e Preenchimento
    google.script.run
      .withSuccessHandler(function(resultado) {
        if (resultado && resultado.encontrado) {
          const campoEmail = document.getElementById('f_Email');
          const campoGenero = document.getElementById('f_Genero');

          // Preenche Email se estiver vazio
          if (campoEmail && !campoEmail.value) {
            campoEmail.value = resultado.email || "";
          }

          // Preenche Gênero se estiver vazio ou não selecionado
          if (campoGenero && (!campoGenero.value || campoGenero.value === "")) {
            campoGenero.value = resultado.genero || "";
            
            // Re-inicializa o Select do Materialize para refletir a mudança
            if (typeof M !== 'undefined' && M.FormSelect) {
              M.FormSelect.init(campoGenero);
            }
          }

          // Garante que as labels do Materialize subam (não fiquem em cima do texto)
          M.updateTextFields();
          M.toast({html: 'Dados recuperados do arquivo!', classes: 'blue darken-2'});
        }
      })
      .buscarMembroNoArquivo(nomeDigitado);
  });

  // Funções de "Placeholder" para as novas ferramentas não darem erro
  function abrirModalGenero() {
    M.toast({ html: 'Funcionalidade Inserir Gênero em breve...', classes: 'amber darken-4' });
  }

  function atualizarDadosOAB() {
    M.toast({ html: 'Sincronização com OAB em desenvolvimento...', classes: 'green darken-4' });
  }

  function novoIdTimeStampJS() {
    const ano = new Date().getFullYear() - 2025;
    const ms = Date.now() % 46656000000;
    return ano.toString(36) + ms.toString(36).padStart(5, '0');
  }

  /**
   * Função Auxiliar para buscar valores no objeto de forma insensível a caso e espaços
   */
  function obterValor(obj, chaveAlvo) {
    if (!obj) return "";
    const alvoBusca = chaveAlvo.toLowerCase().trim();
    const chaveReal = Object.keys(obj).find(k => k.toLowerCase().trim() === alvoBusca);
    return chaveReal ? obj[chaveReal] : "";
  }

  function carregarMembrosJS() {
    const loader = document.getElementById('loaderLista');
    const lista = document.getElementById('listaMembros');

    loader.style.display = 'block';
    lista.style.opacity = '0.5';

    google.script.run
      .withSuccessHandler(function (res) {
        // 'res' agora contém as duas propriedades: membros e cargos
        baseDadosMembros = res.membros || [];
        listaCargosAutocomplete = res.cargos || {};

        loader.style.display = 'none';
        lista.style.opacity = '1';

        // Renderiza a lista usando apenas o array de membros
        renderizarLista(baseDadosMembros);
      })
      .withFailureHandler(function (err) {
        M.toast({ html: 'Erro ao carregar dados', classes: 'red' });
        loader.style.display = 'none';
      })
      .buscarMembrosMacro();
  }

  function renderizarLista(dados) {
    const container = document.getElementById('listaMembros');
    container.innerHTML = '';

    if (!dados || dados.length === 0) {
      container.innerHTML = `
      <div class="center-align grey-text" style="padding:40px;">
        <i class="material-icons" style="font-size: 40px; display: block; margin-bottom: 10px;">search_off</i>
        Nenhum registro encontrado para esta busca.
      </div>`;
      return;
    }

    dados.forEach(m => {
      // CAPTURA DE DADOS
      const id = obterValor(m, "Id");
      const nome = obterValor(m, "Nome");
      const cargo = obterValor(m, "Cargo");
      const email = obterValor(m, "Email");
      const genero = obterValor(m, "Gênero"); // Agora capturando o gênero corretamente

      const item = document.createElement('div');
      item.className = 'collection-item collection-item-membro';

      // ATRIBUTOS CRUCIAL PARA O MODAL DE GÊNERO FUNCIONAR
      item.setAttribute('data-id', id);
      item.setAttribute('data-genero', genero || "");

      item.ondblclick = () => abrirModalMembro('editar', id);

      // MONTAGEM DO HTML (Removido o campo Situação e Tags de Ativo/Inativo)
      item.innerHTML = `
      <div class="membro-content">
        <span class="membro-info-primary">${nome || "Sem Nome"}</span>
        <span class="membro-info-cargo">${cargo || "Sem Cargo"}</span>
        <span class="membro-info-secondary">${email || "E-mail não informado"}</span>
      </div>
      
      <div class="m-actions-right">
        <i class="material-icons btn-action-flat btn-edit-color"
           title="Editar"
           onclick="event.stopPropagation(); abrirModalMembro('editar', '${id}')">edit</i>
        <i class="material-icons btn-action-flat btn-delete-color"
           title="Excluir"
           onclick="event.stopPropagation(); confirmarExclusao('${id}', '${(nome || "").replace(/'/g, "\\'")}')">delete_sweep</i>
      </div>
    `;

      container.appendChild(item);
    });
  }

  function filtrarListaMembros() {
    const termo = document.getElementById('inputBusca').value.toLowerCase();
    const filtrados = baseDadosMembros.filter(m => {
      const nome = obterValor(m, "Nome").toString().toLowerCase();
      const cargo = obterValor(m, "Cargo").toString().toLowerCase();
      const email = obterValor(m, "Email").toString().toLowerCase();
      return nome.includes(termo) || cargo.includes(termo) || email.includes(termo);
    });
    renderizarLista(filtrados);
  }

  /**
   * Abertura do Modal
   */

  /**
   * Gerencia a abertura do modal em modo Criação ou Edição (Instantâneo)
   */
  function abrirModalMembro(modo, id = null) {
    const form = document.getElementById('formMembro');
    form.reset();

    const elemCargo = document.getElementById('f_Cargo');
    const titulo = document.getElementById('modalTitulo');

    if (modo === 'novo') {
      titulo.innerText = 'Cadastrar Novo Membro';
      document.getElementById('f_Id').value = '';
    } else {
      titulo.innerText = 'Visualização e Edição Completa';

      // Busca rápida no cache local
      const m = baseDadosMembros.find(x => obterValor(x, "Id").toString() === (id ? id.toString() : ""));

      if (m) {
        document.getElementById('f_Id').value = obterValor(m, "Id");
        document.getElementById('f_Nome').value = obterValor(m, "Nome");
        document.getElementById('f_Email').value = obterValor(m, "Email");
        document.getElementById('f_Genero').value = obterValor(m, "Gênero");
        document.getElementById('f_Cargo').value = obterValor(m, "Cargo");
      }
    }

    // Inicializa o Autocomplete IMEDIATAMENTE com os cargos do cache inicial
    M.Autocomplete.init(elemCargo, {
      data: listaCargosAutocomplete,
      minLength: 1,
      limit: 5
    });

    // Atualiza componentes visuais do Materialize
    M.updateTextFields();
    M.FormSelect.init(document.querySelectorAll('select'));

    // Abre o modal de forma segura
    const modalElem = document.getElementById('modalMembro');
    const instance = M.Modal.getInstance(modalElem) || M.Modal.init(modalElem);
    instance.open();
  }

  /**
   * Envia os dados para salvamento no Backend
   */
  function salvarMembroJS() {
    const nome = document.getElementById('f_Nome').value;
    const genero = document.getElementById('f_Genero').value;
    const cargo = document.getElementById('f_Cargo').value;

    // APLICAÇÃO DA FORMATAÇÃO: Iniciais Maiúsculas e Preposições Minúsculas
    const nomeFormatado = formatarNomeCompleto(nome);

    // Validação: Apenas Nome e Gênero são obrigatórios
    if (!nomeFormatado || !genero) {
      return M.toast({ html: 'Nome e Gênero são obrigatórios!', classes: 'red' });
    }

    const btn = document.getElementById('btnSalvar');
    btn.disabled = true;
    btn.innerHTML = 'Processando...';

    let idFinal = document.getElementById('f_Id').value || novoIdTimeStampJS();

    const dados = {
      "Id": idFinal,
      "Nome": nomeFormatado,
      "Email": document.getElementById('f_Email').value,
      "Gênero": genero, // Usando a variável capturada acima
      "Cargo": cargo   // Usando a variável capturada acima
    };

    google.script.run
      .withSuccessHandler(function () {
        M.toast({ html: 'Sucesso!', classes: 'green darken-2' });
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons left">save</i>Salvar Registro';
        const inst = M.Modal.getInstance(document.getElementById('modalMembro'));
        if (inst) inst.close();
        carregarMembrosJS();
      })
      .withFailureHandler(function (err) {
        console.error(err);
        M.toast({ html: 'Erro: ' + err.message, classes: 'red' });
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons left">save</i>Salvar Registro';
      })
      .salvarMembroMacro(dados);
  }

  function formatarDataParaInput(dataStr) {
    if (!dataStr) return "";
    const d = new Date(dataStr);
    if (isNaN(d.getTime())) return "";
    const ano = d.getUTCFullYear();
    const mes = (d.getUTCMonth() + 1).toString().padStart(2, '0');
    const dia = d.getUTCDate().toString().padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
  }

  /**
   * Função de Central de Confirmação customizada
   */
  function exibirConfirmacao(titulo, mensagem, icone, callback) {
    const modal = document.getElementById('modalConfirmacao');
    const btnConfirmar = document.getElementById('btnConfirmarAcao');

    document.getElementById('tituloConfirmacao').innerText = titulo;
    document.getElementById('msgConfirmacao').innerText = mensagem;
    document.getElementById('iconConfirmacao').innerText = icone;

    // Limpa eventos anteriores para não duplicar ações
    const novoBtn = btnConfirmar.cloneNode(true);
    btnConfirmar.parentNode.replaceChild(novoBtn, btnConfirmar);

    novoBtn.onclick = function () {
      M.Modal.getInstance(modal).close();
      callback();
    };

    M.Modal.getInstance(modal).open();
  }

  /**
   * Solicita exclusão com Modal customizado
   */
  function confirmarExclusao(id, nome) {
    exibirConfirmacao(
      'Pensa bem!',
      `Esta ação irá remover permanentemente o registro de\n${nome}\n\n` +
      'Deseja mesmo continuar?',
      'delete_forever',
      function () {
        google.script.run.withSuccessHandler(function () {
          M.toast({ html: 'Registro removido com sucesso.' });
          
          // --- limpa o campo de pesquisa ---
          const campoBusca = document.getElementById('inputBusca'); // Verifique se o ID é este
          if (campoBusca) {
            campoBusca.value = ''; 
          }
          
          carregarMembrosJS();
        }).excluirMembroMacro(id);
      }
    );
  }

  // Esta função é chamada pelo clique no botão do Layout
  function atualizarDadosOAB() {
    // 1. Feedback visual imediato
    M.toast({ html: 'Iniciando sincronização com site da OAB...', classes: 'blue' });

    // Opcional: Mostrar o loader que você já tem no topo da lista
    document.getElementById('loaderLista').style.display = 'block';
    document.getElementById('listaMembros').style.opacity = '0.5';

    // 2. Chama a função do Servidor (GS)
    google.script.run
      .withSuccessHandler(function (mensagem) {
        // Quando terminar com sucesso:
        M.toast({ html: mensagem, classes: 'green' });

        // Esconde o loader e atualiza a lista na tela para mostrar os novos nomes
        document.getElementById('loaderLista').style.display = 'none';
        document.getElementById('listaMembros').style.opacity = '1';

        // Chama sua função que recarrega a lista de membros no formulário
        carregarMembrosJS();
      })
      .withFailureHandler(function (erro) {
        // Se der algum erro (site fora do ar, etc)
        M.toast({ html: 'Erro na sincronização: ' + erro, classes: 'red' });
        document.getElementById('loaderLista').style.display = 'none';
        document.getElementById('listaMembros').style.opacity = '1';
      })
      .atualizarTabelaMembros(); // Nome novo da sua função no arquivo .gs
  }

  let listaPendentesGenero = [];
  let indexAtualGenero = 0;
  let dadosParaSalvar = [];

  function abrirModalGenero() {
    // Busca na lista atual do HTML quem está sem gênero
    const membrosHTML = document.querySelectorAll('.collection-item-membro');
    listaPendentesGenero = [];
    dadosParaSalvar = [];
    indexAtualGenero = 0;

    membrosHTML.forEach(item => {
      // Aqui assumimos que se não houver tag de gênero ou texto específico, está vazio
      // Você pode ajustar o seletor conforme a estrutura que o seu carregarMembrosJS gera
      if (item.dataset.genero === "" || item.dataset.genero === "undefined") {
        listaPendentesGenero.push({
          id: item.dataset.id,
          nome: item.querySelector('.membro-info-primary').innerText
        });
      }
    });

    if (listaPendentesGenero.length === 0) {
      return M.toast({ html: 'Todos os membros já possuem gênero definido!', classes: 'green' });
    }

    atualizarInterfaceRapida();
    M.Modal.getInstance(document.getElementById('modalRapidoGenero')).open();

    // Ativa escuta do teclado
    document.addEventListener('keydown', escutaTecladoGenero);
  }

  function atualizarInterfaceRapida() {
    if (indexAtualGenero < listaPendentesGenero.length) {
      document.getElementById('nomeMembroRapido').innerText = listaPendentesGenero[indexAtualGenero].nome;
      document.getElementById('progressoGenero').innerText = `${indexAtualGenero + 1} de ${listaPendentesGenero.length}`;
    } else {
      finalizarAtribuicaoRapida();
    }
  }

  function escutaTecladoGenero(event) {
    const tecla = event.key.toUpperCase();

    if (tecla === 'F') {
      atribuirGeneroRapido('Feminino');
    } else if (tecla === 'M') {
      atribuirGeneroRapido('Masculino');
    } else if (event.key === 'Escape') {
      // Se pressionar Esc, para onde está e salva o que já foi feito
      finalizarAtribuicaoRapida();
    }
  }

  function atribuirGeneroRapido(genero) {
    dadosParaSalvar.push({
      id: listaPendentesGenero[indexAtualGenero].id,
      genero: genero
    });

    indexAtualGenero++;
    atualizarInterfaceRapida();
  }

  function finalizarAtribuicaoRapida() {
    // Remove o ouvinte do teclado imediatamente
    document.removeEventListener('keydown', escutaTecladoGenero);

    // Fecha o modal manualmente
    const instance = M.Modal.getInstance(document.getElementById('modalRapidoGenero'));
    if (instance.isOpen) instance.close();

    if (dadosParaSalvar.length > 0) {
      M.toast({ html: `Salvando ${dadosParaSalvar.length} alterações...`, classes: 'blue' });

      google.script.run
        .withSuccessHandler(function (msg) {
          M.toast({ html: msg, classes: 'green' });
          carregarMembrosJS(); // Atualiza a lista na tela
        })
        .salvarGenerosEmMassa(dadosParaSalvar);
    } else {
      M.toast({ html: 'Nenhuma alteração realizada.', classes: 'grey' });
    }
  }

  /**
   * Formata um nome completo para o padrão: Iniciais maiúsculas para pessoas físicas.
   * Se detectar marcadores de empresa, retorna o texto original.
   * Utiliza mapeamento de preposições em vez de contagem de caracteres.
   */
  function formatarNomeCompleto(nome) {
    if (!nome) return "";
    const nomeLimpo = nome.trim();
    const nomeMinusculo = nomeLimpo.toLowerCase();

    // Marcadores de empresa (PJ)
    const marcadoresEmpresa = [
      "ltda", "s/a", "s.a", "eireli", "me", "epp", "mei", "cia", "companhia",
      "sociedade", "comercial", "comércio", "comercio", "indústria", "industria", "serviços",
      "servicos", "representação", "representacao", "representações", "representacoes",
      "escritório", "escritorio", "advocacia", "associação", "associacao", "cooperativa",
      "instituto", "fundação", "fundacao", "holding", "grupo", "banco", "caixa", "seguradora"
    ];

    // Verifica se é empresa (palavra isolada)
    const ehEmpresa = marcadoresEmpresa.some(marcador => {
      const regex = new RegExp("\\b" + marcador + "\\b", "i");
      return regex.test(nomeMinusculo);
    });

    if (ehEmpresa) return nomeLimpo;

    // Mapeamento explícito de preposições e conectores comuns em nomes
    const preposicoes = ["da", "de", "di", "do", "dos", "das", "e", "del", "von"];

    return nomeMinusculo.split(' ').map(palavra => {
      // Se for uma preposição mapeada, mantém minúsculo
      if (preposicoes.includes(palavra)) {
        return palavra;
      }
      // Caso contrário, capitaliza (incluindo nomes curtos como 'Ana', 'Rui', etc)
      if (palavra.length > 0) {
        return palavra.charAt(0).toUpperCase() + palavra.slice(1);
      }
      return palavra;
    }).join(' ').trim();
  }

</script>